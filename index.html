<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tasks - Notes App</title>
	<link rel="icon" href="favico.ico" type="image/png">
	<link rel="stylesheet" type="text/css" href="styles.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>
<body>
	<!-- Side Nav -->
	<div style="display: flex">
		<div class="hide-on-med-and-down grey lighten-4 side-nav" style="display: flex; flex-direction: column; justify-content: space-between;">
			<div>
				<div class="grey lighten-3 black-text" style="padding: 1rem; padding-left: 1rem; font-size: larger; letter-spacing: 0.5px; color: #483334">
					<div>Tasks and Notes App</div>
				</div>
				<div class="nav_links">
					<div class="nav_item">
						<div><i title="My Day" class="material-icons nav_icon purple_icon">wb_sunny</i></div>
						<div>My Day</div>
					</div>
					<div class="nav_item">
						<div><i title="Notes" class="material-icons nav_icon yellow_icon">note</i></div>
						<div>Notes</div>
					</div>
					<div class="nav_item">
						<div><i title="Important" class="material-icons nav_icon yellow_icon">star</i></div>
						<div>Important</div>
					</div>
					<div class="nav_item" style="justify-content: space-between; align-items: flex-start;" onclick="toggleLists()">
						<div style="display: flex; align-items: flex-start; flex: 6">
							<div><i title="All Lists" class="material-icons nav_icon purple_icon">view_list</i></div>
							<div>Lists</div>
						</div>
						<div style="display: flex; align-items: flex-end;">
							<div id="list_chevron" style="margin-right: 20px; color: #483334">&#x25BC;</div>
						</div>
					</div>
					<div id="user_lists" style="flex-direction: column">
					</div>
				</div>
			</div>
			<div style="position: absolute; width: 20vw; bottom: 0;">
				<!-- Dropdown Trigger -->
				<a id='user_dropdown_trigger' class='dropdown-trigger btn grey lighten-4 black-text' data-target='user_dropdown' style="width: 100%;">#Current_User</a>

				<!-- Dropdown Structure -->
				<ul id='user_dropdown' class='dropdown-content' style="width: 100%">
					<li class="divider" tabindex="-1"></li>
					<li><a class="grey lighten-3 black-text" onclick="createUserModalInstance.open()">Create New User</a></li>
				</ul>
			</div>
		</div>

		<!-- Main Content -->
		<main>
			<!-- Tasks -->
			<div>
				<div>
					<div>
						<h5>My Day</h5>
						<div id="my_day__date"></div>
					</div>
					<div class="my_day_tasks" id="my_day_tasks"></div>
					<div style="margin-top: 4rem">
						<h5>All Tasks</h5>
						<div id="my_day__date"></div>
					</div>
					<div class="all_tasks" id="all_tasks"></div>
				</div>
			</div>

			<!-- Notes -->
			<!-- <div>
				<h5>Notes</h5>
			</div> -->
		</main>
	</div>
	
	<!-- Bottom Bar for Mobile-->
	<footer>
	</footer>

	<!-- FAB -->
	<div class="fixed-action-btn">
		<a class="btn-floating btn-large yellow darken-2">
		  <i title="Create" id="fab_icon" class="large material-icons" onclick="fab()">add</i>
		</a>
		<ul>
		  <li><a class="btn-floating"><i title="Add Task" onclick="fab();createTaskModalInstance.open()" class="material-icons blue accent-4">add_task</i></a></li>
		  <li><a class="btn-floating"><i title="Add Note" onclick="fab();" class="material-icons blue accent-4">note</i></a></li>
		  <li><a class="btn-floating"><i title="Add List" onclick="fab();createListModalInstance.open()" class="material-icons blue accent-4">list</i></a></li>
		</ul>
	</div>

	<!-- Modals -->
	<div id="createListModal" class="modal custom_modal">
		<div class="modal-content">
			<h4>Create List</h4>
			<div class="input-field" style="margin-top: 4rem">
				<input placeholder="" id="create_list_name" type="text" data-length="15">
				<label for="create_list_name">List Name</label>
			</div>
		</div>
		<div class="modal-footer">
			<a class="modal-close waves-effect waves-blue btn-flat black-text" style="margin-right: 0.5rem">Cancel</a>
			<a class="waves-effect waves-blue blue accent-4 btn" onclick="addNewList()">Add List</a>
		</div>
	</div>

	<div id="createUserModal" class="modal custom_modal">
		<div class="modal-content">
			<h4>Create User</h4>
			<div class="input-field" style="margin-top: 4rem">
				<input placeholder="" id="create_user_name" type="text" data-length="15">
				<label for="create_user_name">User Name</label>
			</div>
		</div>
		<div class="modal-footer">
			<a class="modal-close waves-effect waves-blue btn-flat black-text" style="margin-right: 0.5rem">Cancel</a>
			<a class="waves-effect waves-blue blue accent-4 btn" onclick="addNewUser()">Add User</a>
		</div>
	</div>

	<div id="createTaskModal" class="modal custom_modal">
		<form id="createTaskForm" class="modal-content">
			<div style="display: flex; align-items: flex-start">
				<h4 style="margin-bottom: 4rem">Create Task</h4>
				<div style="flex: 1"></div>
				<div><i title="Not Important" class="material-icons nav_icon" id="create_task_important" title="Important" style="color: #ffcc33" onclick="updateCreateTaskImportant()">star_outline</i></div>
			</div>
			<div class="input-field" style="flex: 9">
				<input id="create_task_title" type="text" required>
				<label for="create_task_title">Task Title</label>
			</div>
			<div class="input-field"  style="margin-top: 2rem">
				<input id="create_task_description" type="text" data-length="25">
				<label for="create_task_description">Task Description</label>
			</div>
			<div class="input-field" style="margin-top: 2rem">
				<select id="create_task_listID" required></select>
				<label>Select List</label>
			</div>
			<div class="input-field"  style="margin-top: 2rem">
				<input type="text" id="create_task_due_date" class="datepicker" required>
				<label for="create_task_due_date">Due Date</label>
			</div>
			<div style="display: flex; justify-content: space-between">
				<div class="input-field" style="flex: 2">
					<i  title="Reminder Date" class="material-icons prefix">today</i>
					<input type="text" id="create_task_reminder_date" class="datepicker" required readonly>
					<label for="create_task_reminder_date">Reminder Date</label>
				</div>
				<div style="flex: 1"></div>
				<div class="input-field" style="flex: 2">
					<i title="Reminder Time" class="material-icons prefix">insert_invitation</i>
					<input type="text" id="create_task_reminder_time" class="timepicker" required readonly>
					<label for="create_task_reminder_time">Reminder Time</label>
				</div>
			</div>
		</form>
		<div class="modal-footer">
			<a class="modal-close waves-effect waves-blue btn-flat black-text" style="margin-right: 0.5rem">Cancel</a>
			<a class="waves-effect waves-blue blue accent-4 btn" onclick="addNewTask()">Add Task</a>
		</div>
	</div>

	<div id="updateTaskModal" class="modal custom_modal">
		<form id="udapteTaskForm" class="modal-content">
			<input type="text" id="update_task_id" hidden readonly>
			<input type="text" id="update_task_createdAt" hidden readonly>
			<input type="text" id="update_task_completed" hidden readonly>
			<div style="display: flex; align-items: flex-start">
				<h4 style="margin-bottom: 4rem">Update Task</h4>
				<div style="flex: 1"></div>
				<div><i title="Not Important" class="material-icons nav_icon" id="update_task_important" title="Important" style="color: #ffcc33" onclick="updateCreateTaskImportant()">star_outline</i></div>
			</div>
			<div class="input-field" style="flex: 9">
				<input id="update_task_title" type="text" required>
				<label for="update_task_title">Task Title</label>
			</div>
			<div class="input-field" style="margin-top: 2rem">
				<input id="update_task_description" type="text" data-length="25">
				<label for="update_task_description">Task Description</label>
			</div>
			<div class="input-field" style="margin-top: 2rem">
				<select id="update_task_listID" required></select>
				<label>Select List</label>
			</div>
			<div class="input-field" style="margin-top: 2rem">
				<input type="text" id="update_task_due_date" class="datepicker" required>
				<label for="update_task_due_date">Due Date</label>
			</div>
			<div style="display: flex; justify-content: space-between">
				<div class="input-field" style="flex: 2">
					<i  title="Reminder Date" class="material-icons prefix">today</i>
					<input type="text" id="update_task_reminder_date" class="datepicker" required readonly>
					<label for="update_task_reminder_date">Reminder Date</label>
				</div>
				<div style="flex: 1"></div>
				<div class="input-field" style="flex: 2">
					<i title="Reminder Time" class="material-icons prefix">insert_invitation</i>
					<input type="text" id="update_task_reminder_time" class="timepicker" required readonly>
					<label for="update_task_reminder_time">Reminder Time</label>
				</div>
			</div>
		</form>
		<div class="modal-footer">
			<a class="modal-close waves-effect waves-blue btn-flat black-text" style="margin-right: 0.5rem">Cancel</a>
			<a class="waves-effect waves-blue blue accent-4 btn" onclick="updateTaskDetails()">Update Task</a>
		</div>
	</div>

	<script>
		// Global Variables
		var currentUserName = 'Karan', currentUserID = '2', dbPromise, db, users = [], userNotes = [], userTasks = [], userLists = [], createTaskImportant = "start_outline", todayUserTasks = [], allUserTasks = [];
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
	<script src="/index.js"></script>
	<script>
		// UI JS
		var d = new Date()
		var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
		var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
		document.getElementById("my_day__date").textContent = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]}`;
		document.getElementById("user_dropdown_trigger").textContent = currentUserName

		var showList = false;
		function toggleLists(){
			// Check if we have any lists and then only allow
			if(!showList) {
				document.getElementById("list_chevron").style.transform = 'rotate(180deg)';
				document.getElementById("user_lists").style.display = 'flex';
			} else {
				document.getElementById("user_lists").style.display = 'none';
				document.getElementById("list_chevron").style.transform = 'rotate(0deg)';
			}
			showList = !showList
		}

		// document.addEventListener( "contextmenu", function(e) { e.preventDefault() });

		var fab_status = false;
		function fab(){
			if(!fab_status) document.getElementById('fab_icon').textContent = 'remove';
			else document.getElementById('fab_icon').textContent = 'add';
			fab_status = !fab_status
		}

		//Materialize.css Initializations
		var createListModalInstance, createUserModalInstance, createTaskModalInstance, updateTaskModalInstance;
		document.addEventListener('DOMContentLoaded', function() {
			// Dropdowns
			var elems = document.querySelectorAll('.dropdown-trigger');
			instances = M.Dropdown.init(elems, { constrainWidth: false, coverTrigger: false });
			
			// FABs
			elems = document.querySelectorAll('.fixed-action-btn');
			instances = M.FloatingActionButton.init(elems, { hoverEnabled: false });
			
			// Date Picker
			elems = document.querySelectorAll('.datepicker');
    		instances = M.Datepicker.init(elems, {
				format: 'mm-dd-yyyy',
				minDate: new Date()
			});

			// Time Picker
			elems = document.querySelectorAll('.timepicker');
			instances = M.Timepicker.init(elems, { twelveHour: false });
			
			// Input - Char Count
			M.CharacterCounter.init(document.querySelector('#create_task_description'));
			M.CharacterCounter.init(document.querySelector('#create_user_name'));
			M.CharacterCounter.init(document.querySelector('#create_list_name'));

			// Select element - Initialize after getUserLists()
			// elems = document.querySelectorAll('select');
    		// instances = M.FormSelect.init(elems, {});

			// Modals
			var createListModal = document.querySelector('#createListModal');
			createListModalInstance = M.Modal.init(createListModal, { dismissible: false });
			var createUserModal = document.querySelector('#createUserModal');
			createUserModalInstance = M.Modal.init(createUserModal, { dismissible: false });
			var createTaskModal = document.querySelector("#createTaskModal");
			createTaskModalInstance = M.Modal.init(createTaskModal, { dismissible: false });
			var updateTaskModal = document.querySelector("#updateTaskModal");
			updateTaskModalInstance = M.Modal.init(updateTaskModal, { dismissible: false });
		});

		// IndexedDB Related Functions
		function addNewList(){
			addList({
				userID: currentUserID,
				listTitle: document.getElementById('create_list_name').value
			})
			createListModalInstance.close()
			document.getElementById('create_list_name').value = ''
		}

		function addNewUser(){
			addUser(document.getElementById("create_user_name").value)
			createUserModalInstance.close()
			document.getElementById("create_user_name").value = ''
		}

		function addNewTask(){
			var formData = {
				"taskImportant": createTaskImportant == "star" ? true: false,
				"taskTitle": document.getElementById("create_task_title").value,
				"taskDescription": document.getElementById("create_task_description").value,
				"taskListID": parseInt(document.getElementById("create_task_listID").value),
				"taskDueDate": new Date(document.getElementById("create_task_due_date").value),
				"taskReminderDate": new Date(document.getElementById("create_task_reminder_date").value),
				"taskReminderTime": document.getElementById("create_task_reminder_time").value
			}
			createTaskModalInstance.close()
			document.getElementById("create_task_title").value = ''
			document.getElementById("create_task_description").value = ''
			document.getElementById("create_task_listID").value = ''
			document.getElementById("create_task_due_date").value = ''
			document.getElementById("create_task_reminder_date").value = ''
			document.getElementById("create_task_reminder_time").value = ''
			createTaskImportant = "star_outline"

			addTask(formData)
		}

		function updateCreateTaskImportant(){
			if(createTaskImportant == "star") {
				createTaskImportant = "star_outline"
			} else createTaskImportant = "star"
			document.getElementById("create_task_important").innerHTML = createTaskImportant
		}

		function updateTaskUI(cursor){
			console.log(cursor.value.title)
			document.getElementById("update_task_id").value = cursor.value.id
			document.getElementById("update_task_createdAt").value = cursor.value.created
			document.getElementById("update_task_completed").value = cursor.value.completed
			document.getElementById("update_task_important").innerHTML = cursor.value.important === true ? "star": "star_outline"
			document.getElementById("update_task_title").value = cursor.value.title
			document.getElementById("update_task_description").value = cursor.value.description
			document.getElementById("update_task_listID").value = cursor.value.taskListID
			document.getElementById("update_task_due_date").value = cursor.value.dueDate
			document.getElementById("update_task_reminder_date").value = cursor.value.reminderDate
			document.getElementById("update_task_reminder_time").value = cursor.value.reminderTime
			updateTaskModalInstance.open()
			M.updateTextFields()
			elems = document.querySelectorAll('select');
			instances = M.FormSelect.init(elems, {});
		}

		function updateTaskDetails(){
			var task = {
				"id": parseInt(document.getElementById("update_task_id").value),
				"created": parseInt(document.getElementById("update_task_createdAt").value),
				"completed": document.getElementById("update_task_completed").value == "true" ? true: false,
				"userID": parseInt(currentUserID),
				"important": document.getElementById("update_task_important").innerHTML == "star" ? true: false,
				"title": document.getElementById("update_task_title").value,
				"description": document.getElementById("update_task_description").value,
				"taskListID": parseInt(document.getElementById("update_task_listID").value),
				"dueDate": new Date(document.getElementById("update_task_due_date").value),
				"reminderDate": new Date(document.getElementById("update_task_reminder_date").value),
				"reminderTime": document.getElementById("update_task_reminder_time").value
			}
			var tx = db.transaction('tasks', 'readwrite');
			var store = tx.objectStore('tasks');
			store.put(task);

			tx.oncomplete = function() { 
				console.log(`Updated Task ${task.id} to the Tasks Store!`);
				updateTaskModalInstance.close()
				getUserTasks()
			}
			tx.onerror = function(event) {
				alert("Couldn't create new Task. Check console for more details");
				console.error('error storing task ' + event.target.errorCode);
			}
		}

		function taskCompleted(checkbox, taskEl, cursor){
			if( checkbox.checked ){
				taskEl.classList.add('true')
			} else taskEl.classList.add('false')
			
			var tx = db.transaction('tasks', 'readwrite');
			var store = tx.objectStore('tasks');
			var task = {
				userID: parseInt(cursor.value.userID),
				id: parseInt(cursor.value.id),
				completed: !cursor.value.completed,
				title: cursor.value.title,
				description: cursor.value.description,
				taskListID: cursor.value.taskListID,
				dueDate: cursor.value.dueDate,
				reminderDate: cursor.value.reminderDate,
				reminderTime: cursor.value.reminderTime,
				important: cursor.value.important,
				created: cursor.value.created
			};
			store.put(task);

			tx.oncomplete = function() { console.log(`Updated Task ${cursor.value.id} to the Tasks Store!`); }
			tx.onerror = function(event) {
				alert("Couldn't create new Task. Check console for more details");
				console.error('error storing task ' + event.target.errorCode);
			}
		}

		function updateImportant(starEl, cursor){
			var tx = db.transaction('tasks', 'readwrite');
			var store = tx.objectStore('tasks');

			var task = {
				userID: parseInt(cursor.value.userID),
				id: parseInt(cursor.value.id),
				completed: cursor.value.completed,
				title: cursor.value.title,
				description: cursor.value.description,
				taskListID: cursor.value.taskListID,
				dueDate: cursor.value.dueDate,
				reminderDate: cursor.value.reminderDate,
				reminderTime: cursor.value.reminderTime,
				important: !cursor.value.important,
				created: cursor.value.created
			};
			store.put(task);

			tx.oncomplete = function() { 
				console.log(`Updated Task ${cursor.value.id} to the Tasks Store!`); 
				if(starEl.innerHTML == "star_outline"){
					starEl.innerHTML = "star"
				} else starEl.innerHTML = "star_outline"
			}
			tx.onerror = function(event) {
				alert("Couldn't create new Task. Check console for more details");
				console.error('error storing task ' + event.target.errorCode);
			}
		}

		function deleteTask(cursor){
			var tx = db.transaction('tasks', 'readwrite');
			var store = tx.objectStore('tasks');
			store.delete(cursor.value.id);

			tx.oncomplete = function() { 
				console.log(`Deleted Task ${cursor.value.id} from the Tasks Store!`);
				getUserTasks()
			}
			tx.onerror = function(event) {
				alert("Couldn't create new Task. Check console for more details");
				console.error('error storing task ' + event.target.errorCode);
			}
			M.toast({html: `Task delete successfully`, classes: 'rounded'});
		}

		function updateList(){

		}
	</script>
</body>
</html>